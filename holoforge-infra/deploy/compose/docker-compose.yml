# ══════════════════════════════════════════════════════════════════════════════
# HOLOFORGE - PRODUCTION DOCKER COMPOSE
# ══════════════════════════════════════════════════════════════════════════════
# Usage: docker compose -f docker-compose.yml up -d
# 
# This is the PRODUCTION configuration:
# - Uses pre-built images from registry
# - No volume mounts for code
# - Proper resource limits
# - Health checks enabled
# ══════════════════════════════════════════════════════════════════════════════

services:
  # ───────────────────────────────────────────────────────────────────────────
  # BACKEND API (FastAPI)
  # ───────────────────────────────────────────────────────────────────────────
  backend:
    image: ${REGISTRY:-holoforge}/backend:${VERSION:-latest}
    container_name: holoforge-backend
    restart: unless-stopped
    
    environment:
      - APP_ENV=production
      - MONGO_URL=${MONGO_URL}
      - DB_NAME=${DB_NAME:-holoforge}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    
    volumes:
      # Persistent data volumes
      - uploads_data:/app/uploads
      - videos_data:/app/videos
      - exports_data:/app/exports
    
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2'
        reservations:
          memory: 512M
          cpus: '0.5'
    
    networks:
      - holoforge-network

  # ───────────────────────────────────────────────────────────────────────────
  # FRONTEND (Nginx + React)
  # ───────────────────────────────────────────────────────────────────────────
  frontend:
    image: ${REGISTRY:-holoforge}/frontend:${VERSION:-latest}
    container_name: holoforge-frontend
    restart: unless-stopped
    
    ports:
      - "${FRONTEND_PORT:-80}:80"
    
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s
    
    depends_on:
      backend:
        condition: service_healthy
    
    networks:
      - holoforge-network

  # ───────────────────────────────────────────────────────────────────────────
  # MONGODB (Production: Use managed service instead)
  # ───────────────────────────────────────────────────────────────────────────
  mongodb:
    image: mongo:7.0.5
    container_name: holoforge-mongodb
    restart: unless-stopped
    
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_ROOT_USER:-admin}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_ROOT_PASSWORD}
      - MONGO_INITDB_DATABASE=${DB_NAME:-holoforge}
    
    volumes:
      - mongodb_data:/data/db
    
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    
    deploy:
      resources:
        limits:
          memory: 1G
    
    networks:
      - holoforge-network

# ═══════════════════════════════════════════════════════════════════════════════
# VOLUMES
# ═══════════════════════════════════════════════════════════════════════════════
volumes:
  uploads_data:
    driver: local
  videos_data:
    driver: local
  exports_data:
    driver: local
  mongodb_data:
    driver: local

# ═══════════════════════════════════════════════════════════════════════════════
# NETWORKS
# ═══════════════════════════════════════════════════════════════════════════════
networks:
  holoforge-network:
    driver: bridge
