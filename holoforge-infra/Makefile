# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# HOLOFORGE - UNIFIED BUILD & ORCHESTRATION SYSTEM
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# SINGLE COMMAND WORKFLOWS:
#   make local          â†’ Start frontend + backend together (RECOMMENDED)
#   make local-build    â†’ Rebuild and start
#   make local-stop     â†’ Stop everything
#
# This Makefile is the ONLY interface developers need.
# No scripts. No manual steps. No host runtime dependencies.
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

.PHONY: help local local-build local-stop local-logs local-clean \
        build build-base build-backend build-frontend \
        prod prod-stop prod-logs \
        test lint shell-backend shell-frontend status

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# CONFIGURATION
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
REGISTRY ?= holoforge
VERSION ?= $(shell git describe --tags --always --dirty 2>/dev/null || echo "dev")

# Compose file paths (relative to Makefile location)
COMPOSE_LOCAL = docker compose -f deploy/compose/docker-compose.local.yml
COMPOSE_DEV   = docker compose -f deploy/compose/docker-compose.dev.yml
COMPOSE_PROD  = docker compose -f deploy/compose/docker-compose.yml

# Terminal colors
GREEN  := $(shell tput -Txterm setaf 2 2>/dev/null || echo "")
YELLOW := $(shell tput -Txterm setaf 3 2>/dev/null || echo "")
CYAN   := $(shell tput -Txterm setaf 6 2>/dev/null || echo "")
RED    := $(shell tput -Txterm setaf 1 2>/dev/null || echo "")
RESET  := $(shell tput -Txterm sgr0 2>/dev/null || echo "")

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# HELP
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
help: ## Show this help
	@echo ''
	@echo '${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}'
	@echo '${CYAN}â•‘           HOLOFORGE UNIFIED BUILD SYSTEM                      â•‘${RESET}'
	@echo '${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}'
	@echo ''
	@echo '${GREEN}QUICK START:${RESET}'
	@echo '  ${YELLOW}make local${RESET}        Start frontend + backend together'
	@echo ''
	@echo '${GREEN}ALL COMMANDS:${RESET}'
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  ${YELLOW}%-18s${RESET} %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ''
	@echo '${GREEN}ARCHITECTURE:${RESET}'
	@echo '  Frontend: http://localhost:3000 (React dev server)'
	@echo '  Backend:  http://localhost:8000 (FastAPI)'
	@echo '  Network:  Docker internal DNS (service discovery)'
	@echo ''

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# LOCAL DEVELOPMENT (UNIFIED ORCHESTRATION)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local: ## ðŸš€ Start frontend + backend together (RECOMMENDED)
	@echo ''
	@echo '${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}'
	@echo '${CYAN}â•‘         STARTING HOLOFORGE LOCAL ENVIRONMENT                  â•‘${RESET}'
	@echo '${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}'
	@echo ''
	@echo '${GREEN}Services:${RESET}'
	@echo '  â€¢ Backend (FastAPI):  http://localhost:8000'
	@echo '  â€¢ Frontend (React):   http://localhost:3000'
	@echo ''
	@echo '${YELLOW}Starting services...${RESET}'
	@echo ''
	$(COMPOSE_LOCAL) up

local-build: ## ðŸ”¨ Rebuild images and start (use after Dockerfile changes)
	@echo '${CYAN}Rebuilding and starting services...${RESET}'
	$(COMPOSE_LOCAL) up --build

local-detach: ## ðŸš€ Start in background (detached mode)
	@echo '${CYAN}Starting services in background...${RESET}'
	$(COMPOSE_LOCAL) up -d
	@echo ''
	@echo '${GREEN}Services started in background.${RESET}'
	@echo 'Use ${YELLOW}make local-logs${RESET} to view logs'
	@echo 'Use ${YELLOW}make local-stop${RESET} to stop'

local-stop: ## ðŸ›‘ Stop all local services
	@echo '${CYAN}Stopping services...${RESET}'
	$(COMPOSE_LOCAL) down
	@echo '${GREEN}Services stopped.${RESET}'

local-logs: ## ðŸ“‹ View logs (all services)
	$(COMPOSE_LOCAL) logs -f

local-logs-backend: ## ðŸ“‹ View backend logs only
	$(COMPOSE_LOCAL) logs -f backend

local-logs-frontend: ## ðŸ“‹ View frontend logs only
	$(COMPOSE_LOCAL) logs -f frontend

local-restart: ## ðŸ”„ Restart all services
	@echo '${CYAN}Restarting services...${RESET}'
	$(COMPOSE_LOCAL) restart

local-clean: ## ðŸ§¹ Stop and remove volumes (DESTRUCTIVE)
	@echo '${RED}WARNING: This will delete all local data (uploads, videos, exports)${RESET}'
	@read -p "Are you sure? [y/N] " confirm && [ "$$confirm" = "y" ]
	$(COMPOSE_LOCAL) down -v
	@echo '${GREEN}Cleaned.${RESET}'

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STATUS & DEBUGGING
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

status: ## ðŸ“Š Show service status
	@echo '${CYAN}Service Status:${RESET}'
	@echo ''
	$(COMPOSE_LOCAL) ps
	@echo ''
	@echo '${CYAN}Health Checks:${RESET}'
	@echo ''
	@curl -s http://localhost:8000/api/health 2>/dev/null && echo ' âœ“ Backend healthy' || echo ' âœ— Backend not responding'
	@curl -s http://localhost:3000 2>/dev/null | head -c 100 && echo ' âœ“ Frontend healthy' || echo ' âœ— Frontend not responding'
	@echo ''

shell-backend: ## ðŸš Open shell in backend container
	$(COMPOSE_LOCAL) exec backend /bin/bash

shell-frontend: ## ðŸš Open shell in frontend container
	$(COMPOSE_LOCAL) exec frontend /bin/sh

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PRODUCTION BUILDS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

build: build-base build-backend build-frontend ## ðŸ—ï¸  Build all production images

build-base: ## Build golden base images
	@echo '${CYAN}Building base images...${RESET}'
	docker build -t $(REGISTRY)/base:build-1.0.0 -f deploy/docker/base.build.Dockerfile .
	docker build -t $(REGISTRY)/base:runtime-1.0.0 -f deploy/docker/base.runtime.Dockerfile .

build-backend: ## Build backend production image
	@echo '${CYAN}Building backend image...${RESET}'
	docker build \
		-t $(REGISTRY)/backend:$(VERSION) \
		-t $(REGISTRY)/backend:latest \
		--build-arg BUILD_VERSION=$(VERSION) \
		-f deploy/docker/backend.Dockerfile .

build-frontend: ## Build frontend production image
	@echo '${CYAN}Building frontend image...${RESET}'
	docker build \
		-t $(REGISTRY)/frontend:$(VERSION) \
		-t $(REGISTRY)/frontend:latest \
		--build-arg BUILD_VERSION=$(VERSION) \
		-f deploy/docker/frontend.Dockerfile .

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PRODUCTION DEPLOYMENT
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

prod: ## Start production stack
	@echo '${CYAN}Starting production environment...${RESET}'
	$(COMPOSE_PROD) up -d

prod-stop: ## Stop production stack
	$(COMPOSE_PROD) down

prod-logs: ## View production logs
	$(COMPOSE_PROD) logs -f

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# QUALITY
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

test: ## ðŸ§ª Run tests
	@echo '${CYAN}Running backend tests...${RESET}'
	$(COMPOSE_LOCAL) exec backend pytest tests/ -v || true

lint: ## ðŸ” Run linters
	@echo '${CYAN}Linting backend...${RESET}'
	$(COMPOSE_LOCAL) exec backend python -m ruff check /app || true

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# UTILITIES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

version: ## Show version info
	@echo 'Version: $(VERSION)'
	@echo 'Registry: $(REGISTRY)'

clean-all: ## ðŸ§¹ Remove ALL Docker resources (VERY DESTRUCTIVE)
	@echo '${RED}WARNING: This will remove all HoloForge containers, images, and volumes${RESET}'
	@read -p "Are you sure? [y/N] " confirm && [ "$$confirm" = "y" ]
	$(COMPOSE_LOCAL) down -v 2>/dev/null || true
	$(COMPOSE_PROD) down -v 2>/dev/null || true
	docker images | grep holoforge | awk '{print $$3}' | xargs -r docker rmi -f
	@echo '${GREEN}All cleaned.${RESET}'
